services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: orqestra
      POSTGRES_PASSWORD: orqestra_password
      POSTGRES_DB: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U orqestra -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    ports:
      - "8002:8002"
    environment:
      - DATABASE_URL=postgresql://orqestra:orqestra_password@db:5432/auth_service
      - CORS_ORIGINS=["http://localhost:3000"]
      - ENVIRONMENT=development
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  campaigns-service:
    build:
      context: ./campaigns-service
      dockerfile: Dockerfile
    ports:
      - "8003:8003"
    environment:
      - DATABASE_URL=postgresql://orqestra:orqestra_password@db:5432/campaigns_service
      - CORS_ORIGINS=["http://localhost:3000"]
      - ENVIRONMENT=development
      - AUTH_SERVICE_URL=http://auth-service:8002
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_REGION=us-east-1
      - S3_ENDPOINT_URL=http://localstack:4566
      - S3_PUBLIC_URL=http://localhost:4566
      - S3_BUCKET_NAME=orqestra-creative-pieces
    depends_on:
      db:
        condition: service_healthy
      auth-service:
        condition: service_started
      localstack:
        condition: service_healthy
    restart: unless-stopped

  html-converter-service:
    build:
      context: ./html-converter-service
      dockerfile: Dockerfile
    ports:
      - "8011:8011"
    restart: unless-stopped

  branding-service:
    build:
      context: ./branding-service
      dockerfile: Dockerfile
    ports:
      - "8012:8012"
    environment:
      - PORT=8012
      - LOG_LEVEL=INFO
    restart: unless-stopped

  briefing-enhancer-service:
    build:
      context: ./briefing-enhancer-service
      dockerfile: Dockerfile
    ports:
      - "8001:8001"
    volumes:
      - ./briefing-enhancer-service/evals/results:/app/evals/results
    environment:
      - DATABASE_URL=postgresql://orqestra:orqestra_password@db:5432/briefing_enhancer
      - REDIS_URL=redis://redis:6379/2
      - CACHE_ENABLED=true
      - CACHE_TTL=86400
      - ENVIRONMENT=development
      - CORS_ORIGINS=["http://localhost:3000", "http://localhost:8000"]
      - AUTH_SERVICE_URL=http://auth-service:8002
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - MARITACA_API_KEY=${MARITACA_API_KEY:-}
      - MARITACA_BASE_URL=https://chat.maritaca.ai/api
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2:-false}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY:-}
      - LANGCHAIN_PROJECT=Briefing Enhancer Service
      - LANGSMITH_TRACING_SAMPLING_RATE=${LANGSMITH_TRACING_SAMPLING_RATE:-1.0}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      auth-service:
        condition: service_started
    restart: unless-stopped

  content-validation-service:
    build:
      context: ./content-validation-service
      dockerfile: Dockerfile
    ports:
      - "8004:8004"
    volumes:
      - ./content-validation-service/debug_images:/app/debug_images
    environment:
      - ENVIRONMENT=development
      - CORS_ORIGINS=["http://localhost:3000"]
      - AUTH_SERVICE_URL=http://auth-service:8002
      - LEGAL_SERVICE_URL=http://legal-service:8005
      - CAMPAIGNS_MCP_URL=http://campaigns-service:8003
      - HTML_CONVERTER_MCP_URL=http://html-converter-service:8011
      - BRANDING_MCP_URL=http://branding-service:8012
      - A2A_BASE_URL=http://content-validation-service:8004
      - DATABASE_URL=postgresql://orqestra:orqestra_password@db:5432/content_validation
      - REDIS_URL=redis://redis:6379/1
      - CACHE_ENABLED=true
      - CACHE_TTL=86400
      - HTTP_TIMEOUT=30
      - DEBUG_IMAGES_DIR=/app/debug_images
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2:-false}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY:-}
      - LANGCHAIN_PROJECT=Content Validation Service
      - LANGSMITH_TRACING_SAMPLING_RATE=${LANGSMITH_TRACING_SAMPLING_RATE:-1.0}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      auth-service:
        condition: service_started
      legal-service:
        condition: service_started
      campaigns-service:
        condition: service_started
      html-converter-service:
        condition: service_started
      branding-service:
        condition: service_started
    restart: unless-stopped

  legal-service:
    build:
      context: ./legal-service
      dockerfile: Dockerfile
    ports:
      - "8005:8005"
    volumes:
      - ./legal-service/evals/results:/app/evals/results
    environment:
      - DATABASE_URL=postgresql://orqestra:orqestra_password@db:5432/legal_service
      - ENVIRONMENT=development
      - CORS_ORIGINS=["http://localhost:3000"]
      - WEAVIATE_URL=http://weaviate:8080
      - WEAVIATE_CLASS_NAME=LegalDocuments
      - REDIS_URL=redis://redis:6379/0
      - CACHE_ENABLED=true
      - CACHE_TTL=3600
      - LOG_LEVEL=INFO
      - RERANK_ENABLED=${RERANK_ENABLED:-false}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - MARITACA_API_KEY=${MARITACA_API_KEY:-}
      - MARITACA_BASE_URL=https://chat.maritaca.ai/api
      - COHERE_APIKEY=${COHERE_APIKEY:-}
      - EMBEDDING_MODEL=text-embedding-3-small
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2:-false}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY:-}
      - LANGCHAIN_PROJECT=Legal Service
      - LANGSMITH_TRACING_SAMPLING_RATE=${LANGSMITH_TRACING_SAMPLING_RATE:-1.0}
    depends_on:
      db:
        condition: service_healthy
      weaviate:
        condition: service_healthy
      redis:
        condition: service_healthy
      weaviate-init:
        condition: service_completed_successfully
    restart: unless-stopped

  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - AUTH_SERVICE_URL=http://auth-service:8002
      - CAMPAIGNS_SERVICE_URL=http://campaigns-service:8003
      - BRIEFING_ENHANCER_SERVICE_URL=http://briefing-enhancer-service:8001
      - CONTENT_VALIDATION_SERVICE_URL=http://content-validation-service:8004
      - CORS_ORIGINS=["http://localhost:3000"]
      - ENVIRONMENT=development
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - ALGORITHM=HS256
    depends_on:
      - auth-service
      - campaigns-service
      - briefing-enhancer-service
      - content-validation-service
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - DOCKER_CONTAINER=true
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - api-gateway
    restart: unless-stopped

  localstack:
    image: localstack/localstack:latest
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3
      - PERSISTENCE=1
    volumes:
      - localstack_data:/var/lib/localstack
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  weaviate:
    image: semitechnologies/weaviate:1.29.0
    ports:
      - "8080:8080"
      - "50051:50051"
    environment:
      - QUERY_DEFAULTS_LIMIT=25
      - AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED=true
      - PERSISTENCE_DATA_PATH=/var/lib/weaviate
      - DEFAULT_VECTORIZER_MODULE=none
      - ENABLE_MODULES=reranker-cohere
      - COHERE_APIKEY=${COHERE_APIKEY:-}
      - CLUSTER_HOSTNAME=node1
    volumes:
      - weaviate_data:/var/lib/weaviate
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/v1/.well-known/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  weaviate-init:
    build:
      context: ./legal-service
      dockerfile: scripts/Dockerfile.weaviate-init
    environment:
      - WEAVIATE_URL=http://weaviate:8080
      - DATA_DIR=/app/data
    depends_on:
      weaviate:
        condition: service_healthy
    restart: "no"
  prometheus:
    image: prom/prometheus:v2.53.0
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=7d"
    restart: unless-stopped

  grafana:
    image: grafana/grafana:11.4.0
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=orqestra
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
    restart: unless-stopped

  metabase-db-init:
    image: postgres:16-alpine
    entrypoint: ["sh", "-c", "PGPASSWORD=orqestra_password psql -h db -U orqestra -d postgres -tc \"SELECT 1 FROM pg_database WHERE datname='metabase'\" | grep -q 1 && echo 'DB metabase already exists' || (PGPASSWORD=orqestra_password psql -h db -U orqestra -d postgres -c 'CREATE DATABASE metabase' && echo 'DB metabase created')"]
    depends_on:
      db:
        condition: service_healthy
    restart: "no"

  metabase:
    image: metabase/metabase:v0.52.5
    ports:
      - "3002:3000"
    environment:
      - MB_DB_TYPE=postgres
      - MB_DB_DBNAME=metabase
      - MB_DB_PORT=5432
      - MB_DB_USER=orqestra
      - MB_DB_PASS=orqestra_password
      - MB_DB_HOST=db
      - MB_DB_CONNECTION_URI=postgres://orqestra:orqestra_password@db:5432/metabase?sslmode=disable
      - MB_JETTY_PORT=3000
      - MB_ANON_TRACKING_ENABLED=false
    depends_on:
      db:
        condition: service_healthy
      metabase-db-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 90s
    volumes:
      - metabase_data:/metabase.db
    restart: unless-stopped

  metabase-init:
    build:
      context: ./monitoring/metabase
      dockerfile: Dockerfile
    depends_on:
      metabase:
        condition: service_healthy
      db:
        condition: service_healthy
    restart: "no"

volumes:
  postgres_data:
  localstack_data:
  weaviate_data:
  redis_data:
  prometheus_data:
  grafana_data:
  metabase_data:
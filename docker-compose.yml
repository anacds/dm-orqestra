services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: orqestra
      POSTGRES_PASSWORD: orqestra_password
      POSTGRES_DB: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U orqestra -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    ports:
      - "8002:8002"
    environment:
      - DATABASE_URL=postgresql://orqestra:orqestra_password@db:5432/auth_service
      - CORS_ORIGINS=["http://localhost:3000"]
      - ENVIRONMENT=development
      - SECRET_KEY=dev-secret-key-change-in-production
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  campaigns-service:
    build:
      context: ./campaigns-service
      dockerfile: Dockerfile
    ports:
      - "8003:8003"
    environment:
      - DATABASE_URL=postgresql://orqestra:orqestra_password@db:5432/campaigns_service
      - CORS_ORIGINS=["http://localhost:3000"]
      - ENVIRONMENT=development
      - AUTH_SERVICE_URL=http://auth-service:8002
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_REGION=us-east-1
      - S3_ENDPOINT_URL=http://localstack:4566
      - S3_PUBLIC_URL=http://localhost:4566
      - S3_BUCKET_NAME=orqestra-creative-pieces
    depends_on:
      db:
        condition: service_healthy
      auth-service:
        condition: service_started
      localstack:
        condition: service_healthy
    restart: unless-stopped

  campaigns-mcp-server:
    build:
      context: ./campaigns-mcp-server
      dockerfile: Dockerfile
    ports:
      - "8010:8010"
    environment:
      - CAMPAIGNS_SERVICE_URL=http://campaigns-service:8003
      - PORT=8010
      - MCP_SERVICE_USER_ID=svc-mcp-campaigns
      - MCP_SERVICE_USER_EMAIL=mcp-campaigns@internal
      - MCP_SERVICE_USER_ROLE=Analista de criação
      - MCP_SERVICE_USER_IS_ACTIVE=true
      - HTTP_TIMEOUT=30
    depends_on:
      campaigns-service:
        condition: service_started
    restart: unless-stopped

  html-converter-service:
    build:
      context: ./html-converter-service
      dockerfile: Dockerfile
    ports:
      - "8011:8011"
    restart: unless-stopped

  branding-service:
    build:
      context: ./branding-service
      dockerfile: Dockerfile
    ports:
      - "8012:8012"
    environment:
      - PORT=8012
      - LOG_LEVEL=INFO
    restart: unless-stopped

  briefing-enhancer-service:
    build:
      context: ./briefing-enhancer-service
      dockerfile: Dockerfile
    ports:
      - "8001:8001"
    env_file:
      - ./briefing-enhancer-service/.env
    environment:
      - DATABASE_URL=postgresql://orqestra:orqestra_password@db:5432/briefing_enhancer
      - ENVIRONMENT=development
      - CORS_ORIGINS=["http://localhost:3000", "http://localhost:8000"]
      - AUTH_SERVICE_URL=http://auth-service:8002
      # LangSmith tracing (usa @traceable)
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2:-false}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY:-}
    depends_on:
      db:
        condition: service_healthy
      auth-service:
        condition: service_started
    restart: unless-stopped

  content-validation-service:
    build:
      context: ./content-validation-service
      dockerfile: Dockerfile
    ports:
      - "8004:8004"
    env_file:
      - ./content-validation-service/.env
    volumes:
      - ./content-validation-service/debug_images:/app/debug_images
    environment:
      - ENVIRONMENT=development
      - CORS_ORIGINS=["http://localhost:3000"]
      - AUTH_SERVICE_URL=http://auth-service:8002
      - LEGAL_SERVICE_URL=http://legal-service:8005
      - CAMPAIGNS_MCP_URL=http://campaigns-mcp-server:8010
      - HTML_CONVERTER_MCP_URL=http://html-converter-service:8011
      - BRANDING_MCP_URL=http://branding-service:8012
      - A2A_BASE_URL=http://content-validation-service:8004
      - DATABASE_URL=postgresql://orqestra:orqestra_password@db:5432/content_validation
      - DEBUG_IMAGES_DIR=/app/debug_images
    depends_on:
      db:
        condition: service_healthy
      auth-service:
        condition: service_started
      legal-service:
        condition: service_started
      campaigns-mcp-server:
        condition: service_started
      html-converter-service:
        condition: service_started
      branding-service:
        condition: service_started
    restart: unless-stopped

  legal-service:
    build:
      context: ./legal-service
      dockerfile: Dockerfile
    ports:
      - "8005:8005"
    env_file:
      - ./legal-service/.env
    volumes:
      - ./legal-service/evals/results:/app/evals/results
    environment:
      - DATABASE_URL=postgresql://orqestra:orqestra_password@db:5432/legal_service
      - ENVIRONMENT=development
      - CORS_ORIGINS=["http://localhost:3000"]
      - WEAVIATE_URL=http://weaviate:8080
      # Collection com chunks por seção
      - WEAVIATE_CLASS_NAME=LegalDocuments
      - REDIS_URL=redis://redis:6379/0
      - CACHE_ENABLED=true
      # Reranking: defina como false se não tiver COHERE_APIKEY
      - RERANK_ENABLED=${RERANK_ENABLED:-true}
      # API Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - MARITACA_API_KEY=${MARITACA_API_KEY}
      - COHERE_APIKEY=${COHERE_APIKEY:-}
      - EMBEDDING_MODEL=text-embedding-3-small
    depends_on:
      db:
        condition: service_healthy
      weaviate:
        condition: service_healthy
      redis:
        condition: service_healthy
      weaviate-init:
        condition: service_completed_successfully
    restart: unless-stopped

  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - AUTH_SERVICE_URL=http://auth-service:8002
      - CAMPAIGNS_SERVICE_URL=http://campaigns-service:8003
      - BRIEFING_ENHANCER_SERVICE_URL=http://briefing-enhancer-service:8001
      - CONTENT_VALIDATION_SERVICE_URL=http://content-validation-service:8004
      - CORS_ORIGINS=["http://localhost:3000"]
      - ENVIRONMENT=development
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - ALGORITHM=HS256
    depends_on:
      - auth-service
      - campaigns-service
      - briefing-enhancer-service
      - content-validation-service
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - DOCKER_CONTAINER=true
      - VITE_API_GATEWAY_URL=http://api-gateway:8000
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - api-gateway
    restart: unless-stopped

  localstack:
    image: localstack/localstack:latest
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3
      - DEBUG=1
      - DATA_DIR=/var/lib/localstack/data
      - DOCKER_HOST=unix:///var/run/docker.sock
      - PERSISTENCE=1
    volumes:
      - localstack_data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  weaviate:
    image: semitechnologies/weaviate:1.29.0
    ports:
      - "8080:8080"
      - "50051:50051"
    environment:
      - QUERY_DEFAULTS_LIMIT=25
      - AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED=true
      - PERSISTENCE_DATA_PATH=/var/lib/weaviate
      - DEFAULT_VECTORIZER_MODULE=none
      # Módulo de reranking (requer COHERE_APIKEY)
      - ENABLE_MODULES=reranker-cohere
      - COHERE_APIKEY=${COHERE_APIKEY:-}
      - CLUSTER_HOSTNAME=node1
    volumes:
      - weaviate_data:/var/lib/weaviate
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/v1/.well-known/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Inicializa Weaviate com dados pré-processados (chunks + vetores)
  # Elimina necessidade de gerar embeddings durante startup
  weaviate-init:
    build:
      context: ./legal-service
      dockerfile: scripts/Dockerfile.weaviate-init
    environment:
      - WEAVIATE_URL=http://weaviate:8080
      - DATA_DIR=/app/data
    depends_on:
      weaviate:
        condition: service_healthy
    restart: "no"

volumes:
  postgres_data:
  localstack_data:
  weaviate_data:
  redis_data:
